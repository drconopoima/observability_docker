apiVersion: 1
# Par YAML :
# - https://grafana.com/docs/grafana/latest/alerting/set-up/provision-alerting-resources/file-provisioning/
# - https://github.com/grafana/grafana/blob/main/conf/provisioning/alerting/sample.yaml
# Par API :
# - https://grafana.com/docs/grafana/latest/developers/http_api/alerting_provisioning/#validation-error
groups:
  - orgId: 1
    name: Managed
    folder: GET
    interval: 60s
    rules:
    - uid: More_than_1_call_per_minute
      title: More than 1 call per minute
      condition: B
      data:
      - refId: A
        datasourceUid: mimir
        relativeTimeRange:
          from: 60
          to: 0
        model:
          expression: "rate(fastapi_requests_total{method=\"GET\"}[1m]) > 0"
          intervalMs: 1000
          maxDataPoints: 43200
          refId: A
      - refId: B
        datasourceUid: "-100"
        relativeTimeRange:
          from: 60
          to: 0
        model:
          conditions:
          - evaluator:
              params:
              - 0
              - 0
              type: gt
            operator:
              type: and
            query:
              params:
              - A
            reducer:
              type: count
            type: query
          datasource:
            type: __expr__
            uid: __expr__
          expression: A
          intervalMs: 1000
          maxDataPoints: 43200
          refId: B
          type: classic_conditions
      noDataState: OK
      executionErrorState: Error
      for: 2m
      annotations:
        description: "Receive more than 1 call per minute on GET method"
        summary: "This alert is just a demonstration on how to add alert and notification"
        runbook_url: ""
      labels:
        Creator: TDE
        severity: INFO

contactPoints:
  - orgId: 1
    name: Slack
    receivers:
    - uid: Slack
      type: slack
      settings:
        mentionChannel: here
        mentionUsers: UUC1MDEE8
        url: https://hooks.slack.com/services/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
        username: Grafana Test Auto Alert

policies:
  - orgId: 1
    receiver: Slack
    group_by:
    - grafana_folder
    - alertname
    routes:
